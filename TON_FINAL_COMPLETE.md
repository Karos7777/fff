# ‚úÖ TON –ü–õ–ê–¢–ï–ñ–ò ‚Äî –ü–û–õ–ù–´–ô –¶–ò–ö–õ –†–ê–ë–û–¢–ê–ï–¢!

## üéØ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ TON –∏–Ω–≤–æ–π—Å–∞
- QR-–∫–æ–¥ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è
- Deep link –¥–ª—è TON –∫–æ—à–µ–ª—å–∫–∞
- Payload: `order_<ID>`

### 2. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã (Polling)
- –ö–∞–∂–¥—ã–µ 20 —Å–µ–∫—É–Ω–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è **–Ω–∞—Ç–∏–≤–Ω–æ–≥–æ TON** (–±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —Å—É–º–º–µ ¬±10%

### 3. ‚úÖ –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã
- –ö–Ω–æ–ø–∫–∞ "üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É" –≤ –∑–∞–∫–∞–∑–µ
- Endpoint: `/api/ton/check-payment`

### 4. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤—ã–¥–∞—á–∞ —Ñ–∞–π–ª–∞
- –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã —Å—Ç–∞—Ç—É—Å ‚Üí `paid`
- –ö–Ω–æ–ø–∫–∞ "üì• –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª"
- Endpoint: `/api/orders/:orderId/download`

---

## üìã –ü–æ–ª–Ω—ã–π flow

### 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞—ë—Ç –∑–∞–∫–∞–∑
```
–í—ã–±–∏—Ä–∞–µ—Ç —Ç–æ–≤–∞—Ä ‚Üí "–ö—É–ø–∏—Ç—å" ‚Üí "–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞" ‚Üí "TON"
```

### 2. –°–æ–∑–¥–∞—ë—Ç—Å—è –∏–Ω–≤–æ–π—Å
```
POST /api/orders
{
  "product_id": 8,
  "payment_method": "ton"
}

‚Üí –ë—ç–∫–µ–Ω–¥ —Å–æ–∑–¥–∞—ë—Ç:
  - –ó–∞–∫–∞–∑ (status: pending)
  - –ò–Ω–≤–æ–π—Å (status: pending, payload: order_88)
  - QR-–∫–æ–¥
  - Deep link: ton://transfer/...?amount=50000000&text=order_88
```

### 3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç
```
–°–∫–∞–Ω–∏—Ä—É–µ—Ç QR ‚Üí –û–ø–ª–∞—á–∏–≤–∞–µ—Ç –≤ TON –∫–æ—à–µ–ª—å–∫–µ
```

### 4. Polling –Ω–∞—Ö–æ–¥–∏—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
```
[TON POLLING] –ü—Ä–æ–≤–µ—Ä–∫–∞ 1 –æ–∂–∏–¥–∞—é—â–∏—Ö –∏–Ω–≤–æ–π—Å–æ–≤...
[TON POLLING] ‚úÖ –û–ü–õ–ê–¢–ê –ó–ê–°–ß–ò–¢–ê–ù–ê! {
  orderId: 88,
  invoiceId: 123,
  txHash: "abc123...",
  amountReceived: 50000000,
  expected: 50000000
}

‚Üí –û–±–Ω–æ–≤–ª—è–µ—Ç:
  - invoices.status ‚Üí 'paid'
  - orders.status ‚Üí 'paid'
```

### 5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞—á–∏–≤–∞–µ—Ç —Ñ–∞–π–ª
```
–û—Ç–∫—Ä—ã–≤–∞–µ—Ç "–ú–æ–∏ –∑–∞–∫–∞–∑—ã" ‚Üí –í–∏–¥–∏—Ç –∫–Ω–æ–ø–∫—É "üì• –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª" ‚Üí –°–∫–∞—á–∏–≤–∞–µ—Ç
```

---

## üöÄ –î–µ–ø–ª–æ–π

```bash
git add .
git commit -m "Complete TON payment flow: polling + file delivery"
git push
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –°–æ–∑–¥–∞–π —Ç–µ—Å—Ç–æ–≤—ã–π —Ç–æ–≤–∞—Ä —Å —Ñ–∞–π–ª–æ–º

**SQL:**
```sql
UPDATE products 
SET file_path = 'test-product.txt' 
WHERE id = 8;
```

–ò–ª–∏ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É –¥–æ–±–∞–≤—å –ø–æ–ª–µ `file_path` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞.

### 2. –°–æ–∑–¥–∞–π –∑–∞–∫–∞–∑ —á–µ—Ä–µ–∑ TON

1. –û—Ç–∫—Ä–æ–π Mini App
2. –í—ã–±–µ—Ä–∏ —Ç–æ–≤–∞—Ä ‚Üí "–ö—É–ø–∏—Ç—å"
3. "–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞" ‚Üí "TON"
4. –ü–æ–ª—É—á–∏ QR-–∫–æ–¥

### 3. –û–ø–ª–∞—Ç–∏

**–í–∞—Ä–∏–∞–Ω—Ç A: –†–µ–∞–ª—å–Ω–∞—è –æ–ø–ª–∞—Ç–∞**
- –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π QR –≤ TON –∫–æ—à–µ–ª—å–∫–µ
- –û–ø–ª–∞—Ç–∏ (–º–∏–Ω–∏–º—É–º 0.001 TON)
- –ñ–¥–∏ 20 —Å–µ–∫—É–Ω–¥

**–í–∞—Ä–∏–∞–Ω—Ç B: –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞**
- –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏ "üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É"

### 4. –°–∫–∞—á–∞–π —Ñ–∞–π–ª

- –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ ‚Üí `paid`
- –ü–æ—è–≤–∏—Ç—Å—è –∫–Ω–æ–ø–∫–∞ "üì• –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª"
- –ù–∞–∂–º–∏ ‚Üí —Ñ–∞–π–ª —Å–∫–∞—á–∞–µ—Ç—Å—è

---

## üìä –õ–æ–≥–∏

### –û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ:

```
üíé –ó–∞–ø—É—Å–∫ TON polling –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–ª–∞—Ç—ã (–∫–∞–∂–¥—ã–µ 20 —Å–µ–∫—É–Ω–¥)

[TON POLLING] –ü—Ä–æ–≤–µ—Ä–∫–∞ 1 –æ–∂–∏–¥–∞—é—â–∏—Ö –∏–Ω–≤–æ–π—Å–æ–≤...
[TON POLLING] ‚úÖ –û–ü–õ–ê–¢–ê –ó–ê–°–ß–ò–¢–ê–ù–ê! {
  orderId: 88,
  invoiceId: 123,
  txHash: "abc123...",
  amountReceived: 50000000,
  expected: 50000000
}
```

### –û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏:

```
[DOWNLOAD] –ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ: { orderId: 88, userId: 1 }
[DOWNLOAD] ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞: test-product.txt
```

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏

### Environment Variables

```env
TON_WALLET_ADDRESS=UQCm27jo_LGzzwx49_niSXqEz9ZRRTyxJxa-yD89Wnxb13fx
JWT_SECRET=your-secret-key
```

### Polling –∏–Ω—Ç–µ—Ä–≤–∞–ª

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: **20 —Å–µ–∫—É–Ω–¥**

–ò–∑–º–µ–Ω–∏—Ç—å:
```js
}, 20000); // ‚Üê –∏–∑–º–µ–Ω–∏ –Ω–∞ –Ω—É–∂–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö)
```

### –î–æ–ø—É—Å–∫ –ø–æ —Å—É–º–º–µ

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: **¬±10%**

–ò–∑–º–µ–Ω–∏—Ç—å:
```js
Math.abs(parseInt(t.in_msg.value) - expectedNano) <= expectedNano * 0.1
                                                                    ‚Üë
                                                                  –∏–∑–º–µ–Ω–∏
```

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
tg_magazin_bot/
‚îú‚îÄ‚îÄ files/                      # –ü–∞–ø–∫–∞ —Å —Ñ–∞–π–ª–∞–º–∏ —Ç–æ–≤–∞—Ä–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ test-product.txt       # –¢–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª
‚îú‚îÄ‚îÄ server.js                  # Polling + endpoints
‚îú‚îÄ‚îÄ payment-service.js         # –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–≤–æ–π—Å–æ–≤
‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îú‚îÄ‚îÄ payment.js            # –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ —Å payment_method
‚îÇ   ‚îî‚îÄ‚îÄ orders-manager.js     # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã + —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
```

---

## üéØ Endpoints

### POST `/api/orders`
–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ —Å TON –æ–ø–ª–∞—Ç–æ–π
```json
{
  "product_id": 8,
  "payment_method": "ton"
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "orderId": 88,
  "invoice": {
    "id": 123,
    "amount": 0.05,
    "address": "UQCm27jo...",
    "url": "ton://transfer/...",
    "qr": "https://api.qrserver.com/..."
  }
}
```

### POST `/api/ton/check-payment`
–†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã
```json
{
  "orderId": 88
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "paid": true,
  "message": "–û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!",
  "orderId": 88
}
```

### GET `/api/orders/:orderId/download?token=<JWT>`
–°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞

**–û—Ç–≤–µ—Ç:** –§–∞–π–ª (binary)

---

## üéâ –ò–¢–û–ì

**–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Ä–∞–±–æ—Ç–∞–µ—Ç:**

1. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ —Å TON
2. ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞
3. ‚úÖ –û–ø–ª–∞—Ç–∞ –≤ TON –∫–æ—à–µ–ª—å–∫–µ
4. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (polling –∫–∞–∂–¥—ã–µ 20 —Å–µ–∫)
5. ‚úÖ –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–∫–Ω–æ–ø–∫–∞)
6. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
7. ‚úÖ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:**
- –û–ø–ª–∞—Ç–∏–ª ‚Üí –ü–æ–ª—É—á–∏–ª —Ñ–∞–π–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –ù–∏–∫–∞–∫–∏—Ö —Ä—É—á–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –∞–¥–º–∏–Ω–∞

**–ì–û–¢–û–í–û –ö –ü–†–û–î–ê–ö–®–ï–ù–£!** üöÄüíé

---

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –ï—Å–ª–∏ polling –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é:

1. **–ü—Ä–æ–≤–µ—Ä—å –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞**
   ```bash
   echo $TON_WALLET_ADDRESS
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤—Ä—É—á–Ω—É—é**
   ```
   https://toncenter.com/api/v2/getTransactions?address=<YOUR_ADDRESS>&limit=5
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å —Å—É–º–º—É**
   ```
   expectedNano = amount * 1_000_000_000
   ```

4. **–ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏**
   ```bash
   railway logs --follow | grep "TON POLLING"
   ```

### –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ —Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è:

1. **–ü—Ä–æ–≤–µ—Ä—å file_path –≤ –ë–î**
   ```sql
   SELECT file_path FROM products WHERE id = 8;
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ**
   ```bash
   ls files/
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞**
   ```sql
   SELECT status FROM orders WHERE id = 88;
   ```
   –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: `paid`

---

## üìù TODO (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

- [ ] –î–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ª–∏–º–∏—Ç —Å–∫–∞—á–∏–≤–∞–Ω–∏–π (1 —Ä–∞–∑ –Ω–∞ –∑–∞–∫–∞–∑)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É USDT
- [ ] –î–æ–±–∞–≤–∏—Ç—å webhook (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è)

**–ù–û –ë–ê–ó–û–í–´–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ –£–ñ–ï –†–ê–ë–û–¢–ê–ï–¢!** ‚úÖ
