# ‚úÖ –ù–∞–π–¥–µ–Ω–∞ –ø—Ä–∏—á–∏–Ω–∞ –æ—à–∏–±–∫–∏ 500! v2.4.5

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

```
‚ùå [DB RUN] –û—à–∏–±–∫–∞: null value in column "user_id" of relation "orders" violates not-null constraint
üì¶ [SERVER] User: { role: 'admin', is_admin: true, iat: 1762150329, exp: 1762236729 }
üì¶ [SERVER] user_id: undefined  ‚Üê ‚ùå –ù–ï–¢ ID!
```

**–ü—Ä–∏—á–∏–Ω–∞:** –í –≤–∞—à–µ–º JWT —Ç–æ–∫–µ–Ω–µ **–Ω–µ—Ç –ø–æ–ª—è `id`**!

–¢–æ–∫–µ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ:
- `role: 'admin'`
- `is_admin: true`
- `iat`, `exp`

–ù–æ **–ù–ï–¢:**
- `id` ‚Üê —ç—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞!
- `telegram_id`
- `username`

---

## üîç –ü–æ—á–µ–º—É —Ç–∞–∫ –ø—Ä–æ–∏–∑–æ—à–ª–æ?

–°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –≤—ã –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–ª–∏—Å—å **–¥–æ —Ç–æ–≥–æ**, –∫–∞–∫ —è –¥–æ–±–∞–≤–∏–ª –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Ç–æ–∫–µ–Ω–æ–≤ –≤ `generateToken()`.

**–¢–µ–∫—É—â–∏–π –∫–æ–¥ `generateToken` –ü–†–ê–í–ò–õ–¨–ù–´–ô:**
```javascript
// middleware.js, —Å—Ç—Ä–æ–∫–∏ 79-89
const generateToken = (user) => {
  const payload = {
    id: user.id,              // ‚úÖ –î–æ–±–∞–≤–ª—è–µ—Ç ID
    telegram_id: user.telegram_id,
    username: user.username,
    role: user.is_admin ? 'admin' : 'user',
    is_admin: user.is_admin,
    iat: Math.floor(Date.now() / 1000)
  };
  return jwt.sign(payload, JWT_SECRET, { expiresIn: '24h' });
};
```

–ù–æ –≤–∞—à **—Å—Ç–∞—Ä—ã–π —Ç–æ–∫–µ–Ω** –±—ã–ª —Å–æ–∑–¥–∞–Ω –±–µ–∑ `id`.

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 1: –û—á–∏—Å—Ç–∏—Ç—å localStorage (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

1. –û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É **Console**
3. –í—ã–ø–æ–ª–Ω–∏—Ç–µ:
```javascript
localStorage.clear();
location.reload();
```
4. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –∑–∞–Ω–æ–≤–æ —á–µ—Ä–µ–∑ Telegram
5. **–ì–æ—Ç–æ–≤–æ!** –ù–æ–≤—ã–π —Ç–æ–∫–µ–Ω –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å `id`

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É

–ï—Å–ª–∏ –≤–µ—Ä—Å–∏—è –æ–±–Ω–æ–≤–∏–ª–∞—Å—å –¥–æ `2.4.5`, —Ç–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–æ–ª–∂–Ω–∞ —Å—Ä–∞–±–æ—Ç–∞—Ç—å –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞:

```javascript
// app.js - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –≤–µ—Ä—Å–∏–∏
if (storedVersion !== APP_VERSION) {
  localStorage.clear();
  location.reload();
}
```

---

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞

–ü–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω:

```javascript
// –í –∫–æ–Ω—Å–æ–ª–∏ DevTools
const token = localStorage.getItem('authToken');
const payload = JSON.parse(atob(token.split('.')[1]));
console.log('Payload:', payload);
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
```javascript
{
  id: 123,              // ‚úÖ –ï—Å—Ç—å!
  telegram_id: "853232715",
  username: "admin",
  role: "admin",
  is_admin: true,
  iat: 1762154329,
  exp: 1762240729
}
```

---

## üîÑ –ü–æ—Å–ª–µ –ø–µ—Ä–µ–ª–æ–≥–∏–Ω–∞

1. **–û—á–∏—Å—Ç–∏—Ç–µ localStorage** –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É
2. **–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –∑–∞–Ω–æ–≤–æ**
3. **–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑**

**–î–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å!** ‚úÖ

---

## üìä –õ–æ–≥–∏ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**–î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:**
```
üì¶ [SERVER] –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞...
üì¶ [SERVER] Request body: { product_id: 8 }
üì¶ [SERVER] User: { 
  id: 123,              ‚Üê ‚úÖ –¢–µ–ø–µ—Ä—å –µ—Å—Ç—å!
  telegram_id: "853232715",
  username: "admin",
  role: "admin",
  is_admin: true
}
üì¶ [SERVER] product_id: 8 user_id: 123  ‚Üê ‚úÖ user_id –æ–ø—Ä–µ–¥–µ–ª—ë–Ω!
üì¶ [SERVER] –ó–∞–ø—Ä–æ—Å —Ç–æ–≤–∞—Ä–∞...
üì¶ [SERVER] –¢–æ–≤–∞—Ä –Ω–∞–π–¥–µ–Ω: { ... }
üì¶ [SERVER] –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∑–∞–∫–∞–∑–∞...
üì¶ [SERVER] SQL –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω, –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ...
‚úÖ [SERVER] –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω, result: { ... }
‚úÖ [SERVER] –ó–∞–∫–∞–∑ ID: 29
```

---

## üí° –ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ?

–í –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞ –º–µ–Ω—è–ª—Å—è:

1. **–†–∞–Ω—å—à–µ:** –¢–æ–∫–µ–Ω –º–æ–≥ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ `role` –∏ `is_admin`
2. **–°–µ–π—á–∞—Å:** –¢–æ–∫–µ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ

–í–∞—à —Ç–æ–∫–µ–Ω –±—ã–ª —Å–æ–∑–¥–∞–Ω –≤ —Å—Ç–∞—Ä–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ `localStorage`.

---

## üöÄ –ò—Ç–æ–≥–æ

**–ü—Ä–æ–±–ª–µ–º–∞:** –°—Ç–∞—Ä—ã–π —Ç–æ–∫–µ–Ω –±–µ–∑ `id`  
**–†–µ—à–µ–Ω–∏–µ:** –ü–µ—Ä–µ–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è  
**–ö–æ–º–∞–Ω–¥–∞:** `localStorage.clear(); location.reload();`

**–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –≤—Å—ë –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç!** üéâ

---

**–í–µ—Ä—Å–∏—è:** 2.4.5  
**–°—Ç–∞—Ç—É—Å:** üîç –ü—Ä–æ–±–ª–µ–º–∞ –Ω–∞–π–¥–µ–Ω–∞!

**–û—á–∏—Å—Ç–∏—Ç–µ localStorage –∏ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –∑–∞–Ω–æ–≤–æ!** üîë
