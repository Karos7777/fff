# ‚úÖ –ê–í–¢–û–û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê –û–ü–õ–ê–¢–´ ‚Äî –ì–û–¢–û–í–û!

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

```
[TON POLLING] ‚úÖ –ù–ê–ô–î–ï–ù–û! payload: "order_133"
[TON POLLING] –û–ü–õ–ê–¢–ê –ó–ê–°–ß–ò–¢–ê–ù–ê! –ó–∞–∫–∞–∑ #133
```

**–°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ!** ‚úÖ

**–ù–û:** Frontend –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã"

**–ü—Ä–∏—á–∏–Ω–∞:** –ö–ª–∏–µ–Ω—Ç –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä "–ê –æ–ø–ª–∞—á–µ–Ω –ª–∏ –∑–∞–∫–∞–∑?"

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. API Endpoint –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞

**–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ `routes/orders.js`:**
```js
router.get('/:id/status', authMiddleware, async (req, res) => {
  const orderId = parseInt(req.params.id);
  const userId = req.user.id;

  const result = await db.query(`
    SELECT o.status, i.status as invoice_status
    FROM orders o
    LEFT JOIN invoices i ON o.id = i.order_id
    WHERE o.id = $1 AND o.user_id = $2
  `, [orderId, userId]);

  const order = result.rows[0];
  const paid = order.status === 'paid' || order.invoice_status === 'paid';

  res.json({ paid, status: order.status });
});
```

### 2. –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ

**–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ `payment.js`:**
```js
async startOrderStatusCheck(orderId) {
  console.log('üîÑ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è –∑–∞–∫–∞–∑–∞ #' + orderId);
  
  this.statusCheckInterval = setInterval(async () => {
    const response = await fetch(`/api/orders/${orderId}/status`, {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
      }
    });

    const data = await response.json();
    
    if (data.paid) {
      console.log('‚úÖ –û–ü–õ–ê–¢–ê –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ê!');
      clearInterval(this.statusCheckInterval);
      this.showOrderPaidSuccess(orderId);
    }
  }, 5000); // –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
}
```

### 3. –ü–æ–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã

**–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ `payment.js`:**
```js
showOrderPaidSuccess(orderId) {
  const content = `
    <div class="payment-success">
      <div class="success-icon">üéâ</div>
      <h3>–û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞!</h3>
      
      <div class="success-actions">
        <button class="btn btn-primary" onclick="paymentManager.downloadFile(${orderId})">
          üì• –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª
        </button>
      </div>
    </div>
  `;
  
  this.showModal(content);
}
```

### 4. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞

**–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ `payment.js`:**
```js
async downloadFile(orderId) {
  const token = localStorage.getItem('authToken');
  const downloadUrl = `/api/orders/${orderId}/download?token=${encodeURIComponent(token)}`;
  window.open(downloadUrl, '_blank');
}
```

---

## üöÄ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ–≤—ã–π –∑–∞–∫–∞–∑

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞—ë—Ç –∑–∞–∫–∞–∑ —Å TON**
2. **–û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –æ–∫–Ω–æ –æ–ø–ª–∞—Ç—ã —Å QR-–∫–æ–¥–æ–º**
3. **–ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥:**
   ```
   üîÑ [AUTO-CHECK] –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è –∑–∞–∫–∞–∑–∞ #139
   üîÑ [AUTO-CHECK] –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞: { paid: false }
   üîÑ [AUTO-CHECK] –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞: { paid: false }
   ```
4. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç —á–µ—Ä–µ–∑ TON –∫–æ—à–µ–ª—ë–∫**
5. **TON Polling –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç –æ–ø–ª–∞—Ç—É (8 —Å–µ–∫—É–Ω–¥)**
6. **–ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ:**
   ```
   üîÑ [AUTO-CHECK] –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞: { paid: true }
   ‚úÖ [AUTO-CHECK] –û–ü–õ–ê–¢–ê –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ê!
   ```
7. **–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ–∫–Ω–æ —É—Å–ø–µ—Ö–∞ —Å –∫–Ω–æ–ø–∫–æ–π "–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª"**

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –í–æ–∑–≤—Ä–∞—Ç –∫ –æ–ø–ª–∞—Ç–µ

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç "–ú–æ–∏ –∑–∞–∫–∞–∑—ã"**
2. **–ù–∞–∂–∏–º–∞–µ—Ç "üí≥ –û–ø–ª–∞—Ç–∏—Ç—å"**
3. **–û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –æ–∫–Ω–æ –æ–ø–ª–∞—Ç—ã**
4. **–ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞**
5. **–û–ø–ª–∞—á–∏–≤–∞–µ—Ç ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —É—Å–ø–µ—Ö**

---

## üéâ –ò–¢–û–ì

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ API endpoint `/api/orders/:id/status`
- ‚úÖ –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª" –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
- ‚úÖ –ú–µ—Ç–æ–¥ `showPaymentModal` –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –ù–µ –Ω—É–∂–Ω–æ –Ω–∞–∂–∏–º–∞—Ç—å "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É"
- ‚úÖ –§–∞–π–ª –¥–æ—Å—Ç—É–ø–µ–Ω —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è TON –∏ USDT
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∫ –æ–ø–ª–∞—Ç–µ

**–¢–∞–π–º–ª–∞–π–Ω:**
1. **0 —Å–µ–∫** - –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞, –ø–æ–∫–∞–∑ QR
2. **5 —Å–µ–∫** - –ü–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
3. **10 —Å–µ–∫** - –í—Ç–æ—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
4. **15 —Å–µ–∫** - –¢—Ä–µ—Ç—å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (TON polling —É–∂–µ –∑–∞—Å—á–∏—Ç–∞–ª!)
5. **15 —Å–µ–∫** - ‚úÖ –û–ü–õ–ê–¢–ê –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ê! –ü–æ–∫–∞–∑ –∫–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è

**–ì–û–¢–û–í–û –ö –î–ï–ü–õ–û–Æ!** üöÄüíé

---

## üìù –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

**–ò–Ω—Ç–µ—Ä–≤–∞–ª—ã:**
- TON Polling (—Å–µ—Ä–≤–µ—Ä): **8 —Å–µ–∫—É–Ω–¥**
- Auto-check (–∫–ª–∏–µ–Ω—Ç): **5 —Å–µ–∫—É–Ω–¥**

**–ü–æ—á–µ–º—É 5 —Å–µ–∫—É–Ω–¥ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ?**
- TON polling —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∂–¥—ã–µ 8 —Å–µ–∫—É–Ω–¥
- –ö–ª–∏–µ–Ω—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —á–∞—â–µ (5 —Å–µ–∫)
- –ì–∞—Ä–∞–Ω—Ç–∏—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –≤ —Ç–µ—á–µ–Ω–∏–µ 5-13 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ `authToken` –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ `user_id` –≤ SQL
- ‚úÖ –¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –∑–∞–∫–∞–∑–∞ –º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
- ‚úÖ –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞
- ‚úÖ –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –æ–∫–Ω–∞
- ‚úÖ –õ—ë–≥–∫–∏–π –∑–∞–ø—Ä–æ—Å (—Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç—É—Å, –±–µ–∑ JOIN)

**–ü–†–û–í–ï–†–¨ –í PRODUCTION ‚Äî –î–û–õ–ñ–ù–û –†–ê–ë–û–¢–ê–¢–¨!**
