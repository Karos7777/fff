# ‚úÖ TON POLLING ‚Äî –ò–°–ü–†–ê–í–õ–ï–ù–û (SIGTERM FIX)

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

**SIGTERM –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ** ‚Äî —Å–µ—Ä–≤–µ—Ä –ø–∞–¥–∞–ª —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –≤ polling –∫–æ–¥–µ.

### –ü—Ä–∏—á–∏–Ω—ã:
1. ‚ùå `fetch` –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –≤ Node.js (–Ω—É–∂–µ–Ω –∏–º–ø–æ—Ä—Ç)
2. ‚ùå `db.all()` –º–æ–∂–µ—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å
3. ‚ùå `TON_WALLET_ADDRESS` –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –∑–∞–¥–∞–Ω

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç `node-fetch`
```js
// –ë—ã–ª–æ (–ø–∞–¥–∞–ª–æ):
const res = await fetch(url);

// –°—Ç–∞–ª–æ (—Ä–∞–±–æ—Ç–∞–µ—Ç):
const fetch = (await import('node-fetch')).default;
const res = await fetch(url);
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
```js
if (!process.env.TON_WALLET_ADDRESS) {
  console.warn('‚ö†Ô∏è  TON_WALLET_ADDRESS –Ω–µ –∑–∞–¥–∞–Ω - TON polling –æ—Ç–∫–ª—é—á—ë–Ω');
} else {
  // –ó–∞–ø—É—Å–∫–∞–µ–º polling
}
```

### 3. –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
```js
try {
  // polling –∫–æ–¥
} catch (err) {
  console.error('[TON POLLING] ‚ùå –û—à–∏–±–∫–∞:', err.message);
  // –ù–ï –ø–∞–¥–∞–µ–º, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
}
```

---

## üìã –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ server.js

### –ë—ã–ª–æ:
```js
setInterval(async () => {
  const res = await fetch(url); // ‚ùå fetch –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω
  // ...
}, 20000);
```

### –°—Ç–∞–ª–æ:
```js
if (!process.env.TON_WALLET_ADDRESS) {
  console.warn('‚ö†Ô∏è  TON_WALLET_ADDRESS –Ω–µ –∑–∞–¥–∞–Ω - TON polling –æ—Ç–∫–ª—é—á—ë–Ω');
} else {
  console.log('üíé –ó–∞–ø—É—Å–∫ TON polling...');
  
  setInterval(async () => {
    try {
      const fetch = (await import('node-fetch')).default; // ‚úÖ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç
      const res = await fetch(url);
      // ...
    } catch (err) {
      console.error('[TON POLLING] ‚ùå –û—à–∏–±–∫–∞:', err.message);
    }
  }, 20000);
}
```

---

## üöÄ –î–µ–ø–ª–æ–π

```bash
git add .
git commit -m "Fix TON polling: add dynamic fetch import and error handling"
git push
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:

```bash
railway logs --follow
```

**–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏:**
```
üöÄ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3000
‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∞
üíé –ó–∞–ø—É—Å–∫ TON polling –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–ª–∞—Ç—ã (–∫–∞–∂–¥—ã–µ 20 —Å–µ–∫—É–Ω–¥)
```

–ï—Å–ª–∏ `TON_WALLET_ADDRESS` –Ω–µ –∑–∞–¥–∞–Ω:
```
‚ö†Ô∏è  TON_WALLET_ADDRESS –Ω–µ –∑–∞–¥–∞–Ω - TON polling –æ—Ç–∫–ª—é—á—ë–Ω
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
```bash
railway logs --follow
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```
üöÄ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3000
üíé –ó–∞–ø—É—Å–∫ TON polling...
```

### 2. –°–æ–∑–¥–∞–π –∑–∞–∫–∞–∑ —á–µ—Ä–µ–∑ TON
- Mini App ‚Üí –¢–æ–≤–∞—Ä ‚Üí "–ö—É–ø–∏—Ç—å" ‚Üí "TON"

### 3. –û–ø–ª–∞—Ç–∏

### 4. –ñ–¥–∏ polling (20 —Å–µ–∫)
```
[TON POLLING] –ü—Ä–æ–≤–µ—Ä–∫–∞ 1 –æ–∂–∏–¥–∞—é—â–∏—Ö –∏–Ω–≤–æ–π—Å–æ–≤...
[TON POLLING] ‚úÖ –û–ü–õ–ê–¢–ê –ó–ê–°–ß–ò–¢–ê–ù–ê! { orderId: 105 }
```

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Environment Variables

### Railway:
```bash
railway variables set TON_WALLET_ADDRESS=UQCm27jo_LGzzwx49_niSXqEz9ZRRTyxJxa-yD89Wnxb13fx
```

### –õ–æ–∫–∞–ª—å–Ω–æ (.env):
```env
TON_WALLET_ADDRESS=UQCm27jo_LGzzwx49_niSXqEz9ZRRTyxJxa-yD89Wnxb13fx
```

---

## üì¶ Dependencies

### package.json —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç:
```json
{
  "dependencies": {
    "node-fetch": "^2.7.0"
  }
}
```

‚úÖ –ù–∏—á–µ–≥–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ!

---

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤—Å—ë –µ—â—ë –ø–∞–¥–∞–µ—Ç:

1. **–ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ Railway**
   ```bash
   railway logs --follow
   ```
   –ò—â–∏ —Å—Ç—Ä–æ–∫—É —Å –æ—à–∏–±–∫–æ–π –ø–µ—Ä–µ–¥ `SIGTERM`

2. **–ü—Ä–æ–≤–µ—Ä—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å**
   ```bash
   node -c server.js
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è**
   ```bash
   railway variables
   ```

4. **–õ–æ–∫–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç**
   ```bash
   npm start
   ```

---

## üéâ –ò–¢–û–ì

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç `node-fetch`
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ `TON_WALLET_ADDRESS`
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ –°–µ—Ä–≤–µ—Ä –Ω–µ –ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö polling

**–¢–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- ‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ SIGTERM
- ‚úÖ Polling —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∂–¥—ã–µ 20 —Å–µ–∫
- ‚úÖ –û–ø–ª–∞—Ç–∞ –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

**–ì–û–¢–û–í–û –ö –î–ï–ü–õ–û–Æ!** üöÄüíé
