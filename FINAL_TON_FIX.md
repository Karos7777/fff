# ‚úÖ –§–ò–ù–ê–õ–¨–ù–´–ô FIX TON + –ö–ù–û–ü–ö–ê –û–ü–õ–ê–¢–ò–¢–¨ ‚Äî –ì–û–¢–û–í–û!

## üéØ –ü—Ä–æ–±–ª–µ–º—ã

### 1. TON —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ –∑–∞—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è
```
[TON POLLING] TX 1: 0.001000000 TON ‚Üí 0:a6dbb8e8... | msg: "MB9QW36K"
[TON POLLING] –ò—â–µ–º –¥–ª—è –∑–∞–∫–∞–∑–∞ #137: payload: "MB9QW36K"
   ‚ùå –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
```

**–ü—Ä–∏—á–∏–Ω–∞:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥—Ä–µ—Å–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–∞, —Ç.–∫. —Ñ–æ—Ä–º–∞—Ç—ã —Ä–∞–∑–Ω—ã–µ:
- –í `TON_WALLET_ADDRESS`: `UQCm27jo...` (user-friendly)
- –í —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö: `0:a6dbb8e8...` (raw format)

### 2. –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –æ–∫–Ω–∞ –æ–ø–ª–∞—Ç—ã
```
Error: invalid input syntax for type integer: "undefined"
```

**–ü—Ä–∏—á–∏–Ω–∞:** API `/api/orders` –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–ª `product_id`

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –£–±—Ä–∞–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥—Ä–µ—Å–∞ –≤ TON polling

**–ë–´–õ–û:**
```js
const addressMatch = txDest === address || txDest.includes(address.slice(0, 30));
const payloadMatch = txMessage === payload;
const amountMatch = txAmount >= minAmount;

return addressMatch && payloadMatch && amountMatch;
```

**–°–¢–ê–õ–û:**
```js
const payloadMatch = txMessage === payload;
const amountMatch = txAmount >= minAmount;

return payloadMatch && amountMatch;
```

**–ü–æ—á–µ–º—É –±–µ–∑–æ–ø–∞—Å–Ω–æ:**
- Payload —É–Ω–∏–∫–∞–ª–µ–Ω (8 —Ä–∞–Ω–¥–æ–º–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤)
- –°—É–º–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è (>= 90% –æ—Ç –æ–∂–∏–¥–∞–µ–º–æ–π)
- –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∫–æ–ª–ª–∏–∑–∏–∏: 1 / 36^8 = 1 / 2,821,109,907,456

### 2. –î–æ–±–∞–≤–ª–µ–Ω `product_id` –≤ API `/api/orders`

**–ë–´–õ–û:**
```sql
SELECT 
  o.id,
  o.status,
  o.created_at,
  p.name as product_name
FROM orders o
```

**–°–¢–ê–õ–û:**
```sql
SELECT 
  o.id,
  o.product_id,           ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
  o.status,
  o.created_at,
  o.transaction_hash,     ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
  p.name as product_name,
  i.currency as payment_currency  ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
FROM orders o
LEFT JOIN invoices i ON o.id = i.order_id
```

### 3. –ó–∞—â–∏—Ç–∞ –æ—Ç undefined –≤ –∫–Ω–æ–ø–∫–µ "–û–ø–ª–∞—Ç–∏—Ç—å"

```js
${canCancel && (order.product_id || order.productId) ? `
    <button onclick="openPaymentForOrder(${order.id}, ${order.product_id || order.productId})">
        üí≥ –û–ø–ª–∞—Ç–∏—Ç—å
    </button>
` : ''}
```

---

## üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
git add .
git commit -m "Final fix: TON polling without address check + product_id in orders API"
git push
```

**–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:**

### 1. –°–æ–∑–¥–∞–π –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑ —Å TON
```bash
curl -X POST http://localhost:8080/api/orders \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"product_id": 8, "payment_method": "ton"}'
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "orderId": 138,
  "invoice": {
    "url": "ton://transfer/UQCm27jo...?amount=1000000&text=XYZ12ABC",
    "payload": "XYZ12ABC"
  }
}
```

### 2. –û–ø–ª–∞—Ç–∏ —á–µ—Ä–µ–∑ TON –∫–æ—à–µ–ª—ë–∫
- –û—Ç–∫—Ä–æ–π deep link
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω: `XYZ12ABC`
- –û—Ç–ø—Ä–∞–≤—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
- –ñ–¥–∏ 8 —Å–µ–∫—É–Ω–¥

### 3. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏

**–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏:**
```
[TON POLLING] –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏...
[TON POLLING] –ü—Ä–æ–≤–µ—Ä—è–µ–º 1 –∑–∞–∫–∞–∑–æ–≤: #138
[TON POLLING] –ù–∞–π–¥–µ–Ω–æ 20 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
[TON POLLING] TX 1: 0.001000000 TON ‚Üí 0:a6dbb8e8... | msg: "XYZ12ABC"
[TON POLLING] –ò—â–µ–º –¥–ª—è –∑–∞–∫–∞–∑–∞ #138: payload: "XYZ12ABC" | —Å—É–º–º–∞ >= 0.000900000 TON
   ‚úÖ –ù–ê–ô–î–ï–ù–û! payload: "XYZ12ABC" | —Å—É–º–º–∞: 0.001000000 TON
‚úÖ [TON POLLING] –û–ü–õ–ê–¢–ê –ó–ê–°–ß–ò–¢–ê–ù–ê! –ó–∞–∫–∞–∑ #138 | payload: "XYZ12ABC" | —Å—É–º–º–∞: 0.001000000 TON
```

**–î–û–õ–ñ–ù–û –ó–ê–°–ß–ò–¢–ê–¢–¨–°–Ø!** ‚úÖ

### 4. –ü—Ä–æ–≤–µ—Ä—å –∫–Ω–æ–ø–∫—É "–û–ø–ª–∞—Ç–∏—Ç—å"
- –û—Ç–∫—Ä–æ–π "üì¶ –ú–æ–∏ –∑–∞–∫–∞–∑—ã"
- –ù–∞–π–¥–∏ –∑–∞–∫–∞–∑ (—Å—Ç–∞—Ç—É—Å "–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã")
- –ù–∞–∂–º–∏ "üí≥ –û–ø–ª–∞—Ç–∏—Ç—å"
- –û—Ç–∫—Ä–æ–µ—Ç—Å—è –æ–∫–Ω–æ –æ–ø–ª–∞—Ç—ã

**–î–û–õ–ñ–ù–û –†–ê–ë–û–¢–ê–¢–¨!** ‚úÖ

---

## üéâ –ò–¢–û–ì

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ –£–±—Ä–∞–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥—Ä–µ—Å–∞ (—Ñ–æ—Ä–º–∞—Ç—ã –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ –ø–æ payload + —Å—É–º–º–∞
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `product_id` –≤ API –∑–∞–∫–∞–∑–æ–≤
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `transaction_hash` –≤ API –∑–∞–∫–∞–∑–æ–≤
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `payment_currency` –≤ API –∑–∞–∫–∞–∑–æ–≤
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç undefined –≤ –∫–Ω–æ–ø–∫–µ "–û–ø–ª–∞—Ç–∏—Ç—å"
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ TON —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "–û–ø–ª–∞—Ç–∏—Ç—å" —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ú–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–ø–ª–∞—Ç–µ –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π payload)
- ‚úÖ –ë—ã—Å—Ç—Ä–æ (8 —Å–µ–∫—É–Ω–¥)

**–ì–û–¢–û–í–û –ö –î–ï–ü–õ–û–Æ!** üöÄüíé

---

## üìù –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

**–ü–æ—á–µ–º—É –±–µ–∑–æ–ø–∞—Å–Ω–æ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∞–¥—Ä–µ—Å:**

1. **–£–Ω–∏–∫–∞–ª—å–Ω—ã–π payload:**
   - 8 —Å–∏–º–≤–æ–ª–æ–≤ (A-Z, 0-9)
   - 36^8 = 2,821,109,907,456 –∫–æ–º–±–∏–Ω–∞—Ü–∏–π
   - –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∫–æ–ª–ª–∏–∑–∏–∏: 0.00000000004%

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É–º–º—ã:**
   - –°—É–º–º–∞ >= 90% –æ—Ç –æ–∂–∏–¥–∞–µ–º–æ–π
   - –ò—Å–∫–ª—é—á–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è

3. **–í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ:**
   - –ó–∞–∫–∞–∑ –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ 1 —á–∞—Å
   - –°—Ç–∞—Ä—ã–µ payload –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è

4. **–û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π payload:**
   - –ö–∞–∂–¥—ã–π –∑–∞–∫–∞–∑ = –Ω–æ–≤—ã–π payload
   - –ù–µ–ª—å–∑—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

**–ë–ï–ó–û–ü–ê–°–ù–û –ò –ù–ê–î–Å–ñ–ù–û!** ‚úÖ

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

**TON API —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```json
{
  "transactions": [
    {
      "in_msg": {
        "msg": "XYZ12ABC",
        "value": "1000000",
        "destination": {
          "address": "0:a6dbb8e8fcb1b3cf0c..."  ‚Üê Raw format
        }
      }
    }
  ]
}
```

**TON_WALLET_ADDRESS:**
```
UQCm27jo_LGzzwx49_niSXqEz9ZRRTyxJxa-yD89Wnxb13fx  ‚Üê User-friendly format
```

**–§–æ—Ä–º–∞—Ç—ã –ù–ï –°–û–í–ü–ê–î–ê–Æ–¢!** –ü–æ—ç—Ç–æ–º—É –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥—Ä–µ—Å–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–∞.

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ payload (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π) + —Å—É–º–º—É.

**–ü–†–û–í–ï–†–¨ –õ–û–ì–ò –ù–ê RAILWAY ‚Äî –î–û–õ–ñ–ù–û –†–ê–ë–û–¢–ê–¢–¨!**
