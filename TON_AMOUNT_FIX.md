# ‚úÖ TON AMOUNT = 0 ‚Äî –ò–°–ü–†–ê–í–õ–ï–ù–û!

## üéØ –ü—Ä–æ–±–ª–µ–º–∞ –Ω–∞–π–¥–µ–Ω–∞!

**–í—Å–µ –∏–Ω–≤–æ–π—Å—ã –∏–º–µ–ª–∏ `amount = 0` –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö!**

### –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏:
```
[TON POLLING] –ò—â–µ–º –¥–ª—è –∑–∞–∫–∞–∑–∞ #94 (order_94):
   –û–∂–∏–¥–∞–µ—Ç—Å—è: 0 TON (0 nanoTON)  ‚Üê ‚ùå –ü–†–û–ë–õ–ï–ú–ê!
   –ú–∏–Ω–∏–º—É–º: 0.000000 TON (0 nanoTON)
   ‚ùå –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
```

### –ü—Ä–∏—á–∏–Ω–∞:
–í `payment-service.js` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è **—Å–∏–Ω—Ç–∞–∫—Å–∏—Å SQLite** (`prepare/get`) –≤–º–µ—Å—Ç–æ **PostgreSQL** (`query`).

```js
// ‚ùå –ë—ã–ª–æ (SQLite):
const insertInvoice = this.db.prepare(sql);
const result = await insertInvoice.get(orderId, userId, amount, ...);

// ‚úÖ –°—Ç–∞–ª–æ (PostgreSQL):
const result = await this.db.query(sql, [orderId, userId, amount, ...]);
const invoice = result.rows[0];
```

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `payment-service.js`:

1. **–ó–∞–º–µ–Ω–∏–ª `prepare/get` –Ω–∞ `query`**
2. **–î–æ–±–∞–≤–∏–ª –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ SQL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤**
3. **–ò—Å–ø—Ä–∞–≤–∏–ª –¥–æ—Å—Ç—É–ø –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É —á–µ—Ä–µ–∑ `result.rows[0]`**

---

## üöÄ –î–µ–ø–ª–æ–π

```bash
git add .
git commit -m "Fix TON invoice amount: use PostgreSQL query syntax"
git push
```

---

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏

### –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞:
```
[TON INVOICE] –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: { orderId: 114, userId: 1, amount: 0.001, amountNano: 1000000, payload: 'order_114' }
[TON INVOICE] SQL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: [114, 1, 0.001, 'TON', 'ton://transfer/...', 'order_114']
[TON INVOICE] –£–°–ü–ï–®–ù–û: { id: 150, orderId: 114, userId: 1, amount: 0.001, payload: 'order_114' }
```

### –ü—Ä–∏ polling:
```
[TON POLLING] –ü—Ä–æ–≤–µ—Ä—è–µ–º 1 –∏–Ω–≤–æ–π—Å–æ–≤: order_114
[TON POLLING] –ù–∞–π–¥–µ–Ω–æ 10 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:
   ‚Üí 0.001000 TON | –æ—Ç EQDyRtMn... ‚Üí EQCm27jo... | hash: abc123...
[TON POLLING] –ò—â–µ–º –¥–ª—è –∑–∞–∫–∞–∑–∞ #114 (order_114):
   –û–∂–∏–¥–∞–µ—Ç—Å—è: 0.001 TON (1000000 nanoTON)  ‚Üê ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û!
   –ú–∏–Ω–∏–º—É–º: 0.000900 TON (900000 nanoTON)

‚úÖ [TON POLLING] –û–ü–õ–ê–¢–ê –ó–ê–°–ß–ò–¢–ê–ù–ê! –ó–∞–∫–∞–∑ #114
   –ü–æ–ª—É—á–µ–Ω–æ: 0.001000 TON (1000000 nanoTON)
   –û–∂–∏–¥–∞–ª–æ—Å—å: 0.001 TON (1000000 nanoTON)
   –†–∞–∑–Ω–∏—Ü–∞: 0.00%
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –î–µ–ø–ª–æ–π –∏–∑–º–µ–Ω–µ–Ω–∏–π
```bash
git push
```

### 2. –°–æ–∑–¥–∞–π –ù–û–í–´–ô –∑–∞–∫–∞–∑
- Mini App ‚Üí –¢–æ–≤–∞—Ä ‚Üí "–ö—É–ø–∏—Ç—å" ‚Üí "TON"
- **–í–∞–∂–Ω–æ:** –°—Ç–∞—Ä—ã–µ –∑–∞–∫–∞–∑—ã (#94-#113) –æ—Å—Ç–∞–Ω—É—Ç—Å—è —Å amount=0

### 3. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ —Å–æ–∑–¥–∞–Ω–∏—è
```bash
railway logs --follow | grep "TON INVOICE"
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```
[TON INVOICE] SQL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: [114, 1, 0.001, 'TON', ...]
[TON INVOICE] –£–°–ü–ï–®–ù–û: { amount: 0.001 }  ‚Üê ‚úÖ –ù–ï 0!
```

### 4. –û–ø–ª–∞—Ç–∏ 0.001 TON

### 5. –ñ–¥–∏ polling (8 —Å–µ–∫)
```bash
railway logs --follow | grep "TON POLLING"
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```
[TON POLLING] –ò—â–µ–º –¥–ª—è –∑–∞–∫–∞–∑–∞ #114:
   –û–∂–∏–¥–∞–µ—Ç—Å—è: 0.001 TON (1000000 nanoTON)  ‚Üê ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û!
‚úÖ [TON POLLING] –û–ü–õ–ê–¢–ê –ó–ê–°–ß–ò–¢–ê–ù–ê! –ó–∞–∫–∞–∑ #114
```

---

## üîß –ß—Ç–æ –¥–µ–ª–∞—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º–∏ –∑–∞–∫–∞–∑–∞–º–∏

### –í–∞—Ä–∏–∞–Ω—Ç 1: –£–¥–∞–ª–∏—Ç—å (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
```sql
DELETE FROM invoices WHERE amount = 0 OR amount IS NULL;
DELETE FROM orders WHERE id IN (94, 98, 100, 105, 107, 109, 111, 113);
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –û–±–Ω–æ–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é
```sql
-- –ï—Å–ª–∏ –∑–Ω–∞–µ—à—å –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—É–º–º—É:
UPDATE invoices SET amount = 0.001 WHERE order_id = 94;
UPDATE invoices SET amount = 0.001 WHERE order_id = 98;
-- –∏ —Ç.–¥.
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å
–°—Ç–∞—Ä—ã–µ –∑–∞–∫–∞–∑—ã –Ω–µ –±—É–¥—É—Ç –∑–∞—Å—á–∏—Ç–∞–Ω—ã, –Ω–æ –Ω–æ–≤—ã–µ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.

---

## üéâ –ò–¢–û–ì

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å PostgreSQL –≤–º–µ—Å—Ç–æ SQLite
- ‚úÖ Amount —Ç–µ–ø–µ—Ä—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
- ‚úÖ Polling –≤–∏–¥–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—É–º–º—É

**–¢–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–≤–æ–π—Å–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—É–º–º–æ–π
- ‚úÖ Polling –Ω–∞—Ö–æ–¥–∏—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- ‚úÖ –û–ø–ª–∞—Ç–∞ –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

**–î–ï–ü–õ–û–ô –ò –°–û–ó–î–ê–ô –ù–û–í–´–ô –ó–ê–ö–ê–ó!** üöÄüíé

---

## üêõ –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞–ª–∞—Å—å

### –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–≤–æ–π—Å–∞:
```bash
railway logs --follow | grep "SQL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã"
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```
[TON INVOICE] SQL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: [114, 1, 0.001, 'TON', ...]
                                      ‚Üë
                                   –ù–ï 0!
```

### –ü—Ä–æ–≤–µ—Ä—å –ë–î:
```sql
SELECT id, order_id, amount, currency, status FROM invoices ORDER BY id DESC LIMIT 5;
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```
id  | order_id | amount | currency | status
150 | 114      | 0.001  | TON      | pending  ‚Üê ‚úÖ amount = 0.001
149 | 113      | 0      | TON      | pending  ‚Üê ‚ùå —Å—Ç–∞—Ä—ã–π (amount = 0)
```

**–ì–û–¢–û–í–û!** üéØ
