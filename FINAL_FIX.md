# ‚úÖ –§–∏–Ω–∞–ª—å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ - –£—Å—Ç–æ–π—á–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î

## üéØ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

–í–º–µ—Å—Ç–æ —Ä—É—á–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL —á–µ—Ä–µ–∑ `psql`, –º—ã –∏—Å–ø—Ä–∞–≤–∏–ª–∏ –∫–æ–¥ `payment-service.js`, —á—Ç–æ–±—ã –æ–Ω:

1. ‚úÖ –°–æ–∑–¥–∞–≤–∞–ª —Ç–∞–±–ª–∏—Ü—ã –ø–æ—à–∞–≥–æ–≤–æ
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–ª —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º
3. ‚úÖ –°–æ–∑–¥–∞–≤–∞–ª –∏–Ω–¥–µ–∫—Å—ã —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–ª–æ–Ω–æ–∫
4. ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–ª –∫–∞–∂–¥—ã–π —à–∞–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
5. ‚úÖ –ù–µ –ø–∞–¥–∞–ª –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

## üìù –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ payment-service.js

### –ë—ã–ª–æ (–ø—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥):

```javascript
// ‚ùå –°–æ–∑–¥–∞–≤–∞–ª —Ç–∞–±–ª–∏—Ü—É —Å–æ –≤—Å–µ–º–∏ –∫–æ–ª–æ–Ω–∫–∞–º–∏ —Å—Ä–∞–∑—É
CREATE TABLE IF NOT EXISTS invoices (
  id SERIAL PRIMARY KEY,
  invoice_payload TEXT UNIQUE NOT NULL,  // –ú–æ–≥–ª–∞ –Ω–µ —Å–æ–∑–¥–∞—Ç—å—Å—è
  ...
);

// ‚ùå –ü—ã—Ç–∞–ª—Å—è —Å–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å –Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∫–æ–ª–æ–Ω–∫–µ
CREATE INDEX idx_invoices_payload ON invoices(invoice_payload);
// ERROR: column "invoice_payload" does not exist
```

### –°—Ç–∞–ª–æ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥):

```javascript
// ‚úÖ –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É –ë–ï–ó –ø—Ä–æ–±–ª–µ–º–Ω–æ–π –∫–æ–ª–æ–Ω–∫–∏
CREATE TABLE IF NOT EXISTS invoices (
  id SERIAL PRIMARY KEY,
  order_id INTEGER NOT NULL,
  ...
  // invoice_payload –¥–æ–±–∞–≤–∏–º –æ—Ç–¥–µ–ª—å–Ω–æ
);

// ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É –æ—Ç–¥–µ–ª—å–Ω–æ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
ALTER TABLE invoices 
ADD COLUMN IF NOT EXISTS invoice_payload TEXT UNIQUE;

// ‚úÖ –¢–æ–ª—å–∫–æ —Ç–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞—ë–º –∏–Ω–¥–µ–∫—Å
CREATE INDEX IF NOT EXISTS idx_invoices_payload 
ON invoices(invoice_payload);
```

## üîÑ –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

### –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
```
üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü –ø–ª–∞—Ç–µ–∂–µ–π...
‚úÖ –¢–∞–±–ª–∏—Ü–∞ invoices —Å–æ–∑–¥–∞–Ω–∞ (–±–µ–∑ invoice_payload)
‚úÖ –¢–∞–±–ª–∏—Ü–∞ transactions —Å–æ–∑–¥–∞–Ω–∞
‚úÖ –¢–∞–±–ª–∏—Ü–∞ payment_settings —Å–æ–∑–¥–∞–Ω–∞
```

### –®–∞–≥ 2: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫
```
‚úÖ –ö–æ–ª–æ–Ω–∫–∞ invoice_payload –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞/–¥–æ–±–∞–≤–ª–µ–Ω–∞
üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–æ–Ω–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ orders...
‚úÖ –ö–æ–ª–æ–Ω–∫–∞ payment_method –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞
‚úÖ –ö–æ–ª–æ–Ω–∫–∞ transaction_hash –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞
‚úÖ –ö–æ–ª–æ–Ω–∫–∞ price –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞
```

### –®–∞–≥ 3: –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
```
üîÑ –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤...
‚úÖ –ò–Ω–¥–µ–∫—Å idx_invoices_payload —Å–æ–∑–¥–∞–Ω
‚úÖ –ò–Ω–¥–µ–∫—Å idx_invoices_status —Å–æ–∑–¥–∞–Ω
‚úÖ –ò–Ω–¥–µ–∫—Å idx_transactions_hash —Å–æ–∑–¥–∞–Ω
```

### –®–∞–≥ 4: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
```
‚úÖ –¢–∞–±–ª–∏—Ü—ã –ø–ª–∞—Ç–µ–∂–µ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ
‚úÖ –°–µ—Ä–≤–∏—Å –ø–ª–∞—Ç–µ–∂–µ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
üöÄ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 8080
```

## üöÄ –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –®–∞–≥ 1: –ó–∞–∫–æ–º–º–∏—Ç—å—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

```bash
git add payment-service.js
git commit -m "Fix payment tables initialization - add column checks"
git push
```

### –®–∞–≥ 2: Railway –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç

Railway –æ–±–Ω–∞—Ä—É–∂–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏:
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
2. –ó–∞–ø—É—Å—Ç–∏—Ç —Å–µ—Ä–≤–µ—Ä
3. –í—ã–ø–æ–ª–Ω–∏—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ë–î —Å –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–æ–π

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏

–í Railway ‚Üí Deployments ‚Üí Logs –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:

```
üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL...
üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö PostgreSQL...
‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö PostgreSQL –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ
üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü –ø–ª–∞—Ç–µ–∂–µ–π...
‚úÖ –ö–æ–ª–æ–Ω–∫–∞ invoice_payload –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞/–¥–æ–±–∞–≤–ª–µ–Ω–∞
üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–æ–Ω–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ orders...
‚úÖ –ö–æ–ª–æ–Ω–∫–∞ payment_method –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞
‚úÖ –ö–æ–ª–æ–Ω–∫–∞ transaction_hash –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞
‚úÖ –ö–æ–ª–æ–Ω–∫–∞ price –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞
üîÑ –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤...
‚úÖ –ò–Ω–¥–µ–∫—Å idx_invoices_payload —Å–æ–∑–¥–∞–Ω
‚úÖ –ò–Ω–¥–µ–∫—Å idx_invoices_status —Å–æ–∑–¥–∞–Ω
‚úÖ –ò–Ω–¥–µ–∫—Å idx_transactions_hash —Å–æ–∑–¥–∞–Ω
‚úÖ –¢–∞–±–ª–∏—Ü—ã –ø–ª–∞—Ç–µ–∂–µ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ
‚úÖ –°–µ—Ä–≤–∏—Å –ø–ª–∞—Ç–µ–∂–µ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
üöÄ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 8080
```

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

| –ü—Ä–æ–±–ª–µ–º–∞ | –°—Ç–∞—Ä—ã–π –∫–æ–¥ | –ù–æ–≤—ã–π –∫–æ–¥ |
|----------|------------|-----------|
| –ß–∞—Å—Ç–∏—á–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è | ‚ùå –ü–∞–¥–∞–ª —Å –æ—à–∏–±–∫–æ–π | ‚úÖ –ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É |
| –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫ | ‚ùå –û—à–∏–±–∫–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è | ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ |
| –û—Ç–ª–∞–¥–∫–∞ | ‚ùå –ú–∞–ª–æ –ª–æ–≥–æ–≤ | ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ |
| –ò–Ω–¥–µ–∫—Å—ã | ‚ùå –°–æ–∑–¥–∞–≤–∞–ª–∏—Å—å –Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–æ–ª–æ–Ω–∫–∞—Ö | ‚úÖ –°–æ–∑–¥–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ |
| –ú–∏–≥—Ä–∞—Ü–∏—è | ‚ùå –¢—Ä–µ–±–æ–≤–∞–ª–∞ —Ä—É—á–Ω–æ–≥–æ SQL | ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è |

## üéØ –ß—Ç–æ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:

- ‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –í—Å–µ –∫–æ–ª–æ–Ω–∫–∏ –Ω–∞ –º–µ—Å—Ç–µ
- ‚úÖ –í—Å–µ –∏–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã
- ‚úÖ –¢–æ–≤–∞—Ä—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î
- ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ó–∞–∫–∞–∑—ã –ø–æ–ø–∞–¥–∞—é—Ç –≤ "–ú–æ–∏ –∑–∞–∫–∞–∑—ã"
- ‚úÖ –ü–ª–∞—Ç—ë–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü

### invoices
```sql
id, order_id, user_id, product_id, amount, currency, status,
invoice_payload, telegram_payment_charge_id, 
telegram_provider_payment_charge_id, crypto_address, 
crypto_memo, crypto_tx_hash, crypto_confirmations,
created_at, paid_at, expires_at
```

### transactions
```sql
id, invoice_id, type, status, tx_hash, from_address, 
to_address, amount, fee, block_number, confirmations,
telegram_payment_id, created_at, confirmed_at, metadata
```

### payment_settings
```sql
id, key, value, description, updated_at
```

## üêõ –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫

### –û—à–∏–±–∫–∞ –≤—Å—ë –µ—â—ë –ø–æ—è–≤–ª—è–µ—Ç—Å—è?

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ - –Ω–∞ –∫–∞–∫–æ–º —à–∞–≥–µ –ø–∞–¥–∞–µ—Ç?
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `DATABASE_URL` –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∞–¥—Ä–µ—Å:
   ```
   postgresql://postgres:***@postgres.railway.internal:5432/railway
   ```

### –ù—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã?

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –Ω–∞—á–∞—Ç—å —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ Railway SQL Editor:

```sql
DROP TABLE IF EXISTS transactions CASCADE;
DROP TABLE IF EXISTS payment_settings CASCADE;
DROP TABLE IF EXISTS invoices CASCADE;
```

–ó–∞—Ç–µ–º –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä - —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–¥—É—Ç—Å—è –∑–∞–Ω–æ–≤–æ.

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Railway
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –¥–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —É—Å–ø–µ—à–Ω–æ

---

**–í–µ—Ä—Å–∏—è:** 2.2.1  
**–î–∞—Ç–∞:** 03.11.2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é  
**–†–µ—à–µ–Ω–∏–µ:** –£—Å—Ç–æ–π—á–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î –±–µ–∑ —Ä—É—á–Ω–æ–≥–æ SQL
