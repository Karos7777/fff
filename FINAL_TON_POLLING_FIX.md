# ‚úÖ FINAL TON POLLING FIX ‚Äî –ì–û–¢–û–í–û!

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

```
[TON POLLING] –ò—â–µ–º –¥–ª—è –∑–∞–∫–∞–∑–∞ #131: payload: "order_131"
   ‚ùå –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–ª —Å—Ç–∞—Ä—ã–µ payload (`order_127`, `order_129`)
- –°–∏—Å—Ç–µ–º–∞ –∏—Å–∫–∞–ª–∞ –Ω–æ–≤—ã–π payload (`order_131`)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è —Å—Ç–∞—Ä—ã–π TON Center API (–º–µ–Ω–µ–µ –Ω–∞–¥—ë–∂–Ω—ã–π)

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ TON API v2 (tonapi.io)

**–ë–´–õ–û:** `https://toncenter.com/api/v2/getTransactions`  
**–°–¢–ê–õ–û:** `https://tonapi.io/v2/blockchain/accounts/{address}/transactions`

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ë–æ–ª–µ–µ –Ω–∞–¥—ë–∂–Ω—ã–π API
- ‚úÖ –õ—É—á—à–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `decoded_body.text` –¥–ª—è payload

### 2. –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –ê–î–†–ï–° + PAYLOAD + –°–£–ú–ú–ê

```js
const tx = data.transactions.find(t => {
  const txAmount = parseInt(t.in_msg.value) / 1e9;
  const txDest = t.in_msg.destination?.address || '';
  const txMessage = t.in_msg.decoded_body?.text || t.in_msg.message || '';
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º: –∞–¥—Ä–µ—Å —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ò payload —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ò —Å—É–º–º–∞ >= minAmount
  const addressMatch = txDest === address || txDest.includes(address.slice(0, 30));
  const payloadMatch = txMessage === payload;
  const amountMatch = txAmount >= minAmount;
  
  return addressMatch && payloadMatch && amountMatch;
});
```

### 3. –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

```
[TON POLLING] TX 1: 0.001000000 TON ‚Üí UQCm27jo... | msg: "order_131"
[TON POLLING] TX 2: 0.001000000 TON ‚Üí UQCm27jo... | msg: "order_129"
[TON POLLING] –ò—â–µ–º –¥–ª—è –∑–∞–∫–∞–∑–∞ #131: payload: "order_131" | —Å—É–º–º–∞ >= 0.000900000 TON
‚úÖ [TON POLLING] –û–ü–õ–ê–¢–ê –ó–ê–°–ß–ò–¢–ê–ù–ê! –ó–∞–∫–∞–∑ #131 | payload: "order_131" | —Å—É–º–º–∞: 0.001000000 TON
```

---

## üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
git add .
git commit -m "Final fix: TON polling with tonapi.io and strict payload check"
git push
```

**–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:**

### 1. –°–æ–∑–¥–∞–π –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑
```bash
curl -X POST http://localhost:8080/api/orders \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"product_id": 8, "payment_method": "ton"}'
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "orderId": 132,
  "invoice": {
    "url": "ton://transfer/UQCm27jo...?amount=1000000&text=order_132",
    "amount": "0.001000000"
  }
}
```

### 2. –û–ø–ª–∞—Ç–∏ —á–µ—Ä–µ–∑ TON –∫–æ—à–µ–ª—ë–∫

**–í–ê–ñ–ù–û:**
1. –û—Ç–∫—Ä–æ–π deep link –∏–∑ –æ—Ç–≤–µ—Ç–∞
2. **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û** —É–∫–∞–∂–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π `order_132` (–∏–∑ deep link)
3. –û—Ç–ø—Ä–∞–≤—å —Ä–æ–≤–Ω–æ `0.001 TON` (–∏–ª–∏ –±–æ–ª—å—à–µ)
4. –ñ–¥–∏ 8 —Å–µ–∫—É–Ω–¥

### 3. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏

**–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏:**
```
[TON POLLING] –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏...
[TON POLLING] –ü—Ä–æ–≤–µ—Ä—è–µ–º 1 –∑–∞–∫–∞–∑–æ–≤: #132
[TON POLLING] –ù–∞–π–¥–µ–Ω–æ 20 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
[TON POLLING] TX 1: 0.001000000 TON ‚Üí UQCm27jo_LGzzwx49_n... | msg: "order_132"
[TON POLLING] TX 2: 0.001000000 TON ‚Üí UQCm27jo_LGzzwx49_n... | msg: "order_129"
[TON POLLING] TX 3: 0.500000000 TON ‚Üí EQAabc123... | msg: ""
[TON POLLING] –ò—â–µ–º –¥–ª—è –∑–∞–∫–∞–∑–∞ #132: payload: "order_132" | —Å—É–º–º–∞ >= 0.000900000 TON
‚úÖ [TON POLLING] –û–ü–õ–ê–¢–ê –ó–ê–°–ß–ò–¢–ê–ù–ê! –ó–∞–∫–∞–∑ #132 | payload: "order_132" | —Å—É–º–º–∞: 0.001000000 TON | hash: abc123...
```

---

## üéâ –ò–¢–û–ì

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ TON API v2 (tonapi.io)
- ‚úÖ –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –∞–¥—Ä–µ—Å + payload + —Å—É–º–º–∞
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- ‚úÖ –ò–Ω—Ç–µ—Ä–≤–∞–ª 8 —Å–µ–∫—É–Ω–¥ (–±—ã—Å—Ç—Ä–µ–µ)
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `decoded_body.text` –¥–ª—è payload

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –í–∏–¥–Ω—ã –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å payload
- ‚úÖ –ù–∞—Ö–æ–¥–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
- ‚úÖ –ò—Å–∫–ª—é—á–µ–Ω—ã –ª–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–¥—ë–∂–Ω–æ –∏ –±—ã—Å—Ç—Ä–æ

**–ì–û–¢–û–í–û –ö –î–ï–ü–õ–û–Æ!** üöÄüíé

---

## üìù –í–∞–∂–Ω–æ!

**–ü—Ä–∏ –æ–ø–ª–∞—Ç–µ:**
1. –ò—Å–ø–æ–ª—å–∑—É–π deep link –∏–∑ –æ—Ç–≤–µ—Ç–∞ API
2. **–ù–ï –ú–ï–ù–Ø–ô** –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π ‚Äî –æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `order_132`
3. –û—Ç–ø—Ä–∞–≤—å >= 0.0009 TON (90% –æ—Ç —Å—É–º–º—ã)
4. –ñ–¥–∏ 8 —Å–µ–∫—É–Ω–¥ ‚Äî –¥–æ–ª–∂–Ω–æ –∑–∞—Å—á–∏—Ç–∞—Ç—å—Å—è!

**–ï—Å–ª–∏ –Ω–µ –∑–∞—Å—á–∏—Ç–∞–ª–æ—Å—å:**
- –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ ‚Äî —Ç–∞–º –±—É–¥—É—Ç –í–°–ï —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å payload
- –£–±–µ–¥–∏—Å—å —á—Ç–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Ç–æ—á–Ω–æ `order_132`
- –£–±–µ–¥–∏—Å—å —á—Ç–æ –∞–¥—Ä–µ—Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
- –£–±–µ–¥–∏—Å—å —á—Ç–æ —Å—É–º–º–∞ >= 0.0009 TON

**–ü–†–û–í–ï–†–¨ –õ–û–ì–ò –ù–ê RAILWAY ‚Äî –î–û–õ–ñ–ù–û –†–ê–ë–û–¢–ê–¢–¨!**

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

**TON API v2:**
- Endpoint: `https://tonapi.io/v2/blockchain/accounts/{address}/transactions?limit=20`
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞: `data.transactions[].in_msg.decoded_body.text`
- –õ–∏–º–∏—Ç: 20 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
1. `addressMatch` ‚Äî –∞–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è —Å–æ–≤–ø–∞–¥–∞–µ—Ç
2. `payloadMatch` ‚Äî –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Ç–æ—á–Ω–æ —Å–æ–≤–ø–∞–¥–∞–µ—Ç
3. `amountMatch` ‚Äî —Å—É–º–º–∞ >= 90% –æ—Ç –æ–∂–∏–¥–∞–µ–º–æ–π

**–í—Å–µ 3 —É—Å–ª–æ–≤–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å TRUE!**
