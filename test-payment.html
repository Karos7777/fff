<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã –ø–ª–∞—Ç–µ–∂–µ–π</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .success { color: green; }
        .error { color: red; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã –ø–ª–∞—Ç–µ–∂–µ–π</h1>
    
    <div class="test-section">
        <h2>1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
        <input type="number" id="telegramId" placeholder="Telegram ID" value="123456789">
        <input type="text" id="username" placeholder="Username" value="testuser">
        <button onclick="testAuth()">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è</button>
        <div id="authResult"></div>
    </div>
    
    <div class="test-section">
        <h2>2. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
        <input type="number" id="productId" placeholder="Product ID" value="1">
        <button onclick="testCreateOrder()">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</button>
        <div id="orderResult"></div>
    </div>
    
    <div class="test-section">
        <h2>3. –°–æ–∑–¥–∞–Ω–∏–µ Stars –∏–Ω–≤–æ–π—Å–∞</h2>
        <input type="number" id="starsAmount" placeholder="–°—É–º–º–∞ –≤ Stars" value="100">
        <input type="text" id="starsDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" value="–¢–µ—Å—Ç–æ–≤—ã–π —Ç–æ–≤–∞—Ä">
        <button onclick="testStarsInvoice()">–°–æ–∑–¥–∞—Ç—å Stars –∏–Ω–≤–æ–π—Å</button>
        <div id="starsResult"></div>
    </div>
    
    <div class="test-section">
        <h2>4. –°–æ–∑–¥–∞–Ω–∏–µ –∫—Ä–∏–ø—Ç–æ –∏–Ω–≤–æ–π—Å–∞</h2>
        <input type="number" id="cryptoAmount" placeholder="–°—É–º–º–∞" value="1.5">
        <select id="cryptoCurrency">
            <option value="TON">TON</option>
            <option value="USDT">USDT</option>
        </select>
        <button onclick="testCryptoInvoice()">–°–æ–∑–¥–∞—Ç—å –∫—Ä–∏–ø—Ç–æ –∏–Ω–≤–æ–π—Å</button>
        <div id="cryptoResult"></div>
    </div>
    
    <div class="test-section">
        <h2>5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞</h2>
        <input type="text" id="invoicePayload" placeholder="Invoice Payload">
        <button onclick="testStatus()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
        <div id="statusResult"></div>
    </div>

    <script>
        let authToken = '';
        let currentOrderId = null;
        
        async function testAuth() {
            const telegramId = document.getElementById('telegramId').value;
            const username = document.getElementById('username').value;
            
            try {
                const response = await fetch('/api/auth/telegram', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: parseInt(telegramId),
                        first_name: 'Test',
                        last_name: 'User',
                        username: username
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    authToken = data.token;
                    document.getElementById('authResult').innerHTML = 
                        `<div class="success">‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!</div>
                         <pre>${JSON.stringify(data, null, 2)}</pre>`;
                } else {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                }
            } catch (error) {
                document.getElementById('authResult').innerHTML = 
                    `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }
        
        async function testCreateOrder() {
            const productId = document.getElementById('productId').value;
            
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π endpoint –±–µ–∑ JWT
                const response = await fetch('/api/test-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        product_id: parseInt(productId),
                        user_id: 1
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentOrderId = data.id;
                    document.getElementById('orderResult').innerHTML = 
                        `<div class="success">‚úÖ –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω!</div>
                         <pre>${JSON.stringify(data, null, 2)}</pre>`;
                } else {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞');
                }
            } catch (error) {
                document.getElementById('orderResult').innerHTML = 
                    `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }
        
        async function testStarsInvoice() {
            if (!currentOrderId) {
                alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑!');
                return;
            }
            
            const amount = document.getElementById('starsAmount').value;
            const description = document.getElementById('starsDescription').value;
            
            try {
                const response = await fetch('/api/test-stars-invoice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        orderId: currentOrderId,
                        productId: parseInt(document.getElementById('productId').value),
                        amount: parseInt(amount),
                        description: description
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('invoicePayload').value = data.invoice.payload;
                    document.getElementById('starsResult').innerHTML = 
                        `<div class="success">‚úÖ Stars –∏–Ω–≤–æ–π—Å —Å–æ–∑–¥–∞–Ω!</div>
                         <pre>${JSON.stringify(data, null, 2)}</pre>`;
                } else {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–≤–æ–π—Å–∞');
                }
            } catch (error) {
                document.getElementById('starsResult').innerHTML = 
                    `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }
        
        async function testCryptoInvoice() {
            if (!currentOrderId) {
                alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑!');
                return;
            }
            
            const amount = document.getElementById('cryptoAmount').value;
            const currency = document.getElementById('cryptoCurrency').value;
            
            try {
                const response = await fetch('/api/test-crypto-invoice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        orderId: currentOrderId,
                        productId: parseInt(document.getElementById('productId').value),
                        amount: parseFloat(amount),
                        currency: currency
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('invoicePayload').value = data.invoice.payload;
                    document.getElementById('cryptoResult').innerHTML = 
                        `<div class="success">‚úÖ –ö—Ä–∏–ø—Ç–æ –∏–Ω–≤–æ–π—Å —Å–æ–∑–¥–∞–Ω!</div>
                         <pre>${JSON.stringify(data, null, 2)}</pre>`;
                } else {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–≤–æ–π—Å–∞');
                }
            } catch (error) {
                document.getElementById('cryptoResult').innerHTML = 
                    `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }
        
        async function testStatus() {
            if (!authToken) {
                alert('–°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å!');
                return;
            }
            
            const payload = document.getElementById('invoicePayload').value;
            
            if (!payload) {
                alert('–í–≤–µ–¥–∏—Ç–µ payload –∏–Ω–≤–æ–π—Å–∞!');
                return;
            }
            
            try {
                const response = await fetch(`/api/payments/status/${payload}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('statusResult').innerHTML = 
                        `<div class="success">‚úÖ –°—Ç–∞—Ç—É—Å –ø–æ–ª—É—á–µ–Ω!</div>
                         <pre>${JSON.stringify(data, null, 2)}</pre>`;
                } else {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
                }
            } catch (error) {
                document.getElementById('statusResult').innerHTML = 
                    `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
