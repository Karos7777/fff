# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ authMiddleware - –ù–∞–¥—ë–∂–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ! v2.4.6

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

```
‚ùå [DB RUN] –û—à–∏–±–∫–∞: null value in column "user_id" of relation "orders" violates not-null constraint
üì¶ [SERVER] User: { role: 'admin', is_admin: true, ... }
üì¶ [SERVER] user_id: undefined  ‚Üê ‚ùå –ù–ï–¢ ID!
```

**–ü—Ä–∏—á–∏–Ω–∞:** JWT —Ç–æ–∫–µ–Ω –Ω–µ —Å–æ–¥–µ—Ä–∂–∞–ª –ø–æ–ª–µ `id` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ - –î–≤–∞ –ø–æ–¥—Ö–æ–¥–∞

### ‚ùå –ü–æ–¥—Ö–æ–¥ 1: –ü—Ä–æ—Å—Ç–æ –æ—á–∏—Å—Ç–∏—Ç—å localStorage (–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ)

```javascript
localStorage.clear();
location.reload();
```

**–ú–∏–Ω—É—Å—ã:**
- –ù—É–∂–Ω–æ –ø–µ—Ä–µ–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è
- –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
- –°—Ç–∞—Ä—ã–µ —Ç–æ–∫–µ–Ω—ã –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å

### ‚úÖ –ü–æ–¥—Ö–æ–¥ 2: –ü–æ–ª—É—á–∞—Ç—å ID –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–ù–ê–î–Å–ñ–ù–û–ï –†–ï–®–ï–ù–ò–ï!)

**–ü–µ—Ä–µ–¥–µ–ª–∞–ª–∏ `authMiddleware` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –õ–Æ–ë–´–ú–ò —Ç–æ–∫–µ–Ω–∞–º–∏:**

```javascript
// middleware.js
const authMiddleware = (db) => {
  return async (req, res, next) => {
    const decoded = jwt.verify(token, JWT_SECRET);
    
    // –ï—Å–ª–∏ –≤ —Ç–æ–∫–µ–Ω–µ –µ—Å—Ç—å id - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
    if (decoded.id) {
      const dbUser = await db.prepare('SELECT * FROM users WHERE id = ?').get(decoded.id);
      req.user = {
        id: dbUser.id,  // ‚Üê –ò–∑ –ë–î!
        telegram_id: dbUser.telegram_id,
        username: dbUser.username,
        role: dbUser.is_admin ? 'admin' : 'user',
        is_admin: dbUser.is_admin
      };
    } 
    // Fallback: –µ—Å–ª–∏ –µ—Å—Ç—å telegram_id
    else if (decoded.telegram_id) {
      const dbUser = await db.prepare('SELECT * FROM users WHERE telegram_id = ?').get(decoded.telegram_id);
      req.user = {
        id: dbUser.id,  // ‚Üê –ò–∑ –ë–î!
        // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
      };
    }
    
    next();
  };
};
```

---

## üîß –ß—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ

### 1. `middleware.js` - –ü–µ—Ä–µ–¥–µ–ª–∞–Ω authMiddleware

**–ë—ã–ª–æ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**
```javascript
const authMiddleware = (req, res, next) => {
  const decoded = jwt.verify(token, JWT_SECRET);
  
  // –ü—Ä–æ—Å—Ç–æ –±–µ—Ä—ë–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–æ–∫–µ–Ω–∞
  req.user = decoded;  // ‚ùå –ï—Å–ª–∏ –≤ —Ç–æ–∫–µ–Ω–µ –Ω–µ—Ç id - –µ–≥–æ –∏ –Ω–µ –±—É–¥–µ—Ç!
  next();
};
```

**–°—Ç–∞–ª–æ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**
```javascript
const authMiddleware = (db) => {
  return async (req, res, next) => {
    const decoded = jwt.verify(token, JWT_SECRET);
    
    // –ü–æ–ª—É—á–∞–µ–º –ê–ö–¢–£–ê–õ–¨–ù–´–ï –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î
    if (decoded.id) {
      const dbUser = await db.prepare('SELECT * FROM users WHERE id = ?').get(decoded.id);
      req.user = { id: dbUser.id, ... };  // ‚úÖ –í—Å–µ–≥–¥–∞ –µ—Å—Ç—å id!
    } else if (decoded.telegram_id) {
      const dbUser = await db.prepare('SELECT * FROM users WHERE telegram_id = ?').get(decoded.telegram_id);
      req.user = { id: dbUser.id, ... };  // ‚úÖ Fallback - —Ç–æ–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!
    }
    
    next();
  };
};
```

### 2. `server.js` - –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

**–°–æ–∑–¥–∞–ª–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä middleware:**
```javascript
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö PostgreSQL
const db = new PostgresAdapter(process.env.DATABASE_URL);

// –°–æ–∑–¥–∞—ë–º —ç–∫–∑–µ–º–ø–ª—è—Ä authMiddleware —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ db
const authMiddlewareWithDB = authMiddleware(db);
```

**–ó–∞–º–µ–Ω–∏–ª–∏ –≤–æ –≤—Å–µ—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö:**
```javascript
// –ë—ã–ª–æ
app.post('/api/orders', authMiddleware, async (req, res) => { ... });

// –°—Ç–∞–ª–æ
app.post('/api/orders', authMiddlewareWithDB, async (req, res) => { ... });
```

**–û–±–Ω–æ–≤–ª–µ–Ω–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤:** 15+

---

## ‚ú® –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è

### 1. –†–∞–±–æ—Ç–∞–µ—Ç —Å–æ –°–¢–ê–†–´–ú–ò —Ç–æ–∫–µ–Ω–∞–º–∏ ‚úÖ
```javascript
// –°—Ç–∞—Ä—ã–π —Ç–æ–∫–µ–Ω: { role: 'admin', is_admin: true, telegram_id: '853232715' }
// Middleware –Ω–∞–π–¥—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ telegram_id –∏ –¥–æ–±–∞–≤–∏—Ç id!
```

### 2. –†–∞–±–æ—Ç–∞–µ—Ç —Å –ù–û–í–´–ú–ò —Ç–æ–∫–µ–Ω–∞–º–∏ ‚úÖ
```javascript
// –ù–æ–≤—ã–π —Ç–æ–∫–µ–Ω: { id: 123, telegram_id: '853232715', ... }
// Middleware –∏—Å–ø–æ–ª—å–∑—É–µ—Ç id –Ω–∞–ø—Ä—è–º—É—é
```

### 3. –ù–ï –ù–£–ñ–ù–û –ø–µ—Ä–µ–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è! ‚úÖ
- –°—Ç–∞—Ä—ã–µ —Ç–æ–∫–µ–Ω—ã –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- –ù–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã —Ç–æ–∂–µ —Ä–∞–±–æ—Ç–∞—é—Ç
- –í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!

### 4. –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î ‚úÖ
```javascript
// –î–∞–∂–µ –µ—Å–ª–∏ –≤ —Ç–æ–∫–µ–Ω–µ —Å—Ç–∞—Ä–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è,
// middleware –ø–æ–ª—É—á–∏—Ç –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
```

---

## üìä –õ–æ–≥–∏ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**–¢–µ–ø–µ—Ä—å –≤ –ª–æ–≥–∞—Ö –±—É–¥–µ—Ç:**

```
üì¶ [SERVER] –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞...
üì¶ [SERVER] Request body: { product_id: 8 }
üì¶ [SERVER] User: { 
  id: 123,              ‚Üê ‚úÖ –¢–µ–ø–µ—Ä—å –í–°–ï–ì–î–ê –µ—Å—Ç—å!
  telegram_id: "853232715",
  username: "admin",
  role: "admin",
  is_admin: true
}
üì¶ [SERVER] product_id: 8 user_id: 123  ‚Üê ‚úÖ user_id –æ–ø—Ä–µ–¥–µ–ª—ë–Ω!
üì¶ [SERVER] –ó–∞–ø—Ä–æ—Å —Ç–æ–≤–∞—Ä–∞...
üì¶ [SERVER] –¢–æ–≤–∞—Ä –Ω–∞–π–¥–µ–Ω: { ... }
üì¶ [SERVER] –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∑–∞–∫–∞–∑–∞...
‚úÖ [SERVER] –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω, result: { ... }
‚úÖ [SERVER] –ó–∞–∫–∞–∑ ID: 30
```

**–û—à–∏–±–∫–∏ –±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç!** ‚úÖ

---

## üß™ –ß—Ç–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

### –¢–µ—Å—Ç 1: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ —Å–æ —Å—Ç–∞—Ä—ã–º —Ç–æ–∫–µ–Ω–æ–º
1. –ù–ï –æ—á–∏—â–∞–π—Ç–µ localStorage
2. –ù–ï –ø–µ—Ä–µ–ª–æ–≥–∏–Ω–∏–≤–∞–π—Ç–µ—Å—å
3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑
4. **–î–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å!** ‚úÖ

### –¢–µ—Å—Ç 2: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º
1. –û—á–∏—Å—Ç–∏—Ç–µ localStorage
2. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –∑–∞–Ω–æ–≤–æ
3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑
4. **–î–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å!** ‚úÖ

### –¢–µ—Å—Ç 3: –û–ø–ª–∞—Ç–∞ —Ç–æ–≤–∞—Ä–∞
1. –°–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑
2. –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã (Stars/TON/USDT)
3. **–î–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å!** ‚úÖ

---

## üîÑ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

| –¢–∏–ø —Ç–æ–∫–µ–Ω–∞ | id | telegram_id | –†–∞–±–æ—Ç–∞–µ—Ç? |
|------------|----|----|-----------|
| –ù–æ–≤—ã–π | ‚úÖ | ‚úÖ | ‚úÖ –û—Ç–ª–∏—á–Ω–æ |
| –°—Ç–∞—Ä—ã–π (—Å telegram_id) | ‚ùå | ‚úÖ | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç (fallback) |
| –°–æ–≤—Å–µ–º —Å—Ç–∞—Ä—ã–π | ‚ùå | ‚ùå | ‚ö†Ô∏è –ù—É–∂–µ–Ω –ø–µ—Ä–µ–ª–æ–≥–∏–Ω |

---

## üöÄ –î–µ–ø–ª–æ–π

```bash
‚úÖ Commit: 922573f
‚úÖ Message: "Fix authMiddleware: get user ID from database for all tokens v2.4.6"
‚úÖ Push: –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
```

Railway –ø–µ—Ä–µ–¥–µ–ø–ª–æ–∏—Ç —á–µ—Ä–µ–∑ 2-3 –º–∏–Ω—É—Ç—ã.

---

## üí° –ü–æ—á–µ–º—É —ç—Ç–æ –ª—É—á—à–µ–µ —Ä–µ—à–µ–Ω–∏–µ?

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü—Ä–æ—Å—Ç–æ –æ—á–∏—Å—Ç–∏—Ç—å localStorage
```
üëé –ú–∏–Ω—É—Å—ã:
- –ù—É–∂–Ω–æ –ø–µ—Ä–µ–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è
- –°—Ç–∞—Ä—ã–µ —Ç–æ–∫–µ–Ω—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç
- –ù—É–∂–Ω–æ –æ–±—ä—è—Å–Ω—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü–æ–ª—É—á–∞—Ç—å –∏–∑ –ë–î (–Ω–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ)
```
üëç –ü–ª—é—Å—ã:
- –†–∞–±–æ—Ç–∞–µ—Ç —Å–æ –≤—Å–µ–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏
- –ù–ï –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è
- –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î
- –ë–æ–ª–µ–µ –Ω–∞–¥—ë–∂–Ω–æ
- –ë–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ
```

---

## üìù –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### 1. `middleware.js`
- –ü–µ—Ä–µ–¥–µ–ª–∞–Ω `authMiddleware` –≤ —Ñ—É–Ω–∫—Ü–∏—é-—Ñ–∞–±—Ä–∏–∫—É
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î
- –î–æ–±–∞–≤–ª–µ–Ω fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤

### 2. `server.js`
- –°–æ–∑–¥–∞–Ω `authMiddlewareWithDB = authMiddleware(db)`
- –ó–∞–º–µ–Ω–µ–Ω—ã –≤—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `authMiddleware` –Ω–∞ `authMiddlewareWithDB`
- –û–±–Ω–æ–≤–ª–µ–Ω–æ 15+ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤

### 3. `public/app.js`
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ –≤–µ—Ä—Å–∏—è –¥–æ `2.4.6`

### 4. `public/index.html`
- –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤–µ—Ä—Å–∏–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤ –¥–æ `2.4.6`

### 5. `package.json`
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ –≤–µ—Ä—Å–∏—è –¥–æ `2.4.6`

---

## üéØ –ò—Ç–æ–≥

**–ü—Ä–æ–±–ª–µ–º–∞:** `user_id: undefined` –∏–∑-–∑–∞ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ —Ç–æ–∫–µ–Ω–æ–≤  
**–†–µ—à–µ–Ω–∏–µ:** –ü–æ–ª—É—á–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î –¥–ª—è –õ–Æ–ë–´–• —Ç–æ–∫–µ–Ω–æ–≤  
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –†–∞–±–æ—Ç–∞–µ—Ç —Å–æ –≤—Å–µ–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏, –Ω–µ –Ω—É–∂–µ–Ω –ø–µ—Ä–µ–ª–æ–≥–∏–Ω! ‚úÖ

---

**–í–µ—Ä—Å–∏—è:** 2.4.6  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞ –Ω–∞–¥—ë–∂–Ω–æ!

**–¢–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞–∫–∞–∑—ã –ë–ï–ó –ø–µ—Ä–µ–ª–æ–≥–∏–Ω–∞!** üéâ
