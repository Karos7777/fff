# üîÑ –†–ï–§–ê–ö–¢–û–†–ò–ù–ì SERVER.JS ‚Äî –ú–û–î–£–õ–¨–ù–ê–Ø –°–¢–†–£–ö–¢–£–†–ê

## üéØ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

–†–∞–∑–¥–µ–ª–∏–ª `server.js` –Ω–∞ –º–æ–¥—É–ª–∏ –¥–ª—è –ª—É—á—à–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∫–æ–¥–∞:

```
tg_magazin_bot/
‚îú‚îÄ‚îÄ server.js              ‚Üê –≥–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª (–∑–∞–ø—É—Å–∫ + —Ä–æ—É—Ç—ã)
‚îú‚îÄ‚îÄ routes/                ‚Üê API endpoints
‚îÇ   ‚îú‚îÄ‚îÄ orders.js         ‚Üê –∑–∞–∫–∞–∑—ã (—Å–æ–∑–¥–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ, —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ)
‚îÇ   ‚îî‚îÄ‚îÄ ton.js            ‚Üê TON –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã
‚îú‚îÄ‚îÄ services/              ‚Üê –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îî‚îÄ‚îÄ tonPolling.js     ‚Üê –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ TON
‚îú‚îÄ‚îÄ middleware.js          ‚Üê —É–∂–µ –µ—Å—Ç—å
‚îî‚îÄ‚îÄ payment-service.js     ‚Üê —É–∂–µ –µ—Å—Ç—å
```

---

## üìã –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### 1. `routes/orders.js`
**–°–æ–¥–µ—Ä–∂–∏—Ç:**
- `POST /` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
- `GET /` ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `DELETE /:id` ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
- `GET /:orderId/download` ‚Äî —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞

### 2. `routes/ton.js`
**–°–æ–¥–µ—Ä–∂–∏—Ç:**
- `GET /check/:orderId` ‚Äî –±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
- `POST /check-payment` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ TON API

### 3. `services/tonPolling.js`
**–°–æ–¥–µ—Ä–∂–∏—Ç:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ TON —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–∫–∞–∑–æ–≤

---

## üîß –ö–∞–∫ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

#### –®–∞–≥ 1: –ü–æ–¥–∫–ª—é—á–∏ –º–æ–¥—É–ª–∏ –≤ `server.js`

–î–æ–±–∞–≤—å –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞ (–ø–æ—Å–ª–µ require):
```js
// –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ä–æ—É—Ç—ã
const ordersRoutes = require('./routes/orders');
const tonRoutes = require('./routes/ton');
const tonPolling = require('./services/tonPolling');
```

#### –®–∞–≥ 2: –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π —Ä–æ—É—Ç—ã

–ù–∞–π–¥–∏ –º–µ—Å—Ç–æ, –≥–¥–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã —Ä–æ—É—Ç—ã (–ø–æ—Å–ª–µ middleware), –¥–æ–±–∞–≤—å:
```js
// –°–æ—Ö—Ä–∞–Ω—è–µ–º paymentService –≤ app –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ —Ä–æ—É—Ç–æ–≤
app.set('paymentService', paymentService);

// –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–æ–¥—É–ª—å–Ω—ã–µ —Ä–æ—É—Ç—ã
app.use('/api/orders', ordersRoutes(db, authMiddlewareWithDB));
app.use('/api/ton', tonRoutes(db, authMiddlewareWithDB));
```

#### –®–∞–≥ 3: –ó–∞–ø—É—Å—Ç–∏ polling

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (–≤–Ω—É—Ç—Ä–∏ `app.listen`):
```js
app.listen(targetPort, '0.0.0.0', () => {
  console.log(`üöÄ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${targetPort}`);
  
  // –ó–∞–ø—É—Å–∫–∞–µ–º TON polling
  tonPolling(db);
  
  // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
});
```

#### –®–∞–≥ 4: –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π —Å—Ç–∞—Ä—ã–µ —Ä–æ—É—Ç—ã

–í `server.js` –Ω–∞–π–¥–∏ –∏ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π:
- `app.post('/api/orders', ...)`
- `app.get('/api/orders', ...)`
- `app.delete('/api/orders/:id', ...)`
- `app.get('/api/orders/:orderId/download', ...)`
- `app.get('/api/ton/check/:orderId', ...)`
- `app.post('/api/ton/check-payment', ...)`
- –ë–ª–æ–∫ TON polling –≤ `setInterval`

#### –®–∞–≥ 5: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π

```bash
npm start
```

–ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏:
```
‚úÖ TON Polling —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω
üíé –ó–∞–ø—É—Å–∫ TON polling –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–ª–∞—Ç—ã (–∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥)
```

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü–æ–ª–Ω–∞—è –∑–∞–º–µ–Ω–∞ (–±—ã—Å—Ç—Ä–æ)

1. –°–¥–µ–ª–∞–π –±—ç–∫–∞–ø:
```bash
cp server.js server.js.backup
```

2. –£–¥–∞–ª–∏ –∏–∑ `server.js`:
   - –í—Å–µ —Ä–æ—É—Ç—ã `/api/orders/*`
   - –í—Å–µ —Ä–æ—É—Ç—ã `/api/ton/*`
   - –ë–ª–æ–∫ TON polling

3. –î–æ–±–∞–≤—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª–µ–π (—Å–º. –í–∞—Ä–∏–∞–Ω—Ç 1)

4. –î–µ–ø–ª–æ–π:
```bash
git add .
git commit -m "Refactor: split server.js into modules"
git push
```

---

## üìä –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### –î–æ (1 —Ñ–∞–π–ª):
```
server.js (2160 —Å—Ç—Ä–æ–∫)
‚îú‚îÄ‚îÄ –†–æ—É—Ç—ã
‚îú‚îÄ‚îÄ Middleware
‚îú‚îÄ‚îÄ –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îú‚îÄ‚îÄ Polling
‚îî‚îÄ‚îÄ –í—Å—ë —Å–º–µ—à–∞–Ω–æ
```

### –ü–æ—Å–ª–µ (–º–æ–¥—É–ª–∏):
```
server.js (500 —Å—Ç—Ä–æ–∫)
‚îú‚îÄ‚îÄ routes/orders.js (200 —Å—Ç—Ä–æ–∫)
‚îú‚îÄ‚îÄ routes/ton.js (100 —Å—Ç—Ä–æ–∫)
‚îî‚îÄ‚îÄ services/tonPolling.js (80 —Å—Ç—Ä–æ–∫)
```

**–ò—Ç–æ–≥–æ:**
- ‚úÖ –ö–æ–¥ —Ä–∞–∑–¥–µ–ª—ë–Ω –ø–æ —Ñ—É–Ω–∫—Ü–∏—è–º
- ‚úÖ –õ–µ–≥–∫–æ –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω—ã–π endpoint
- ‚úÖ –ü—Ä–æ—â–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
- ‚úÖ –ò–ò –ª—É—á—à–µ –ø–æ–Ω–∏–º–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
```bash
curl -X POST http://localhost:8080/api/orders \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"product_id": 8, "payment_method": "ton"}'
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ TON –æ–ø–ª–∞—Ç—ã
```bash
curl http://localhost:8080/api/ton/check/114 \
  -H "Authorization: Bearer <token>"
```

### 3. –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
```bash
curl -X DELETE http://localhost:8080/api/orders/94 \
  -H "Authorization: Bearer <token>"
```

### 4. Polling –ª–æ–≥–∏
```bash
railway logs --follow | grep "TON POLLING"
```

---

## üö® –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

### 1. PaymentService –¥–æ—Å—Ç—É–ø
–í —Ä–æ—É—Ç–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:
```js
const paymentService = req.app.get('paymentService');
```

–£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤ `server.js` –µ—Å—Ç—å:
```js
app.set('paymentService', paymentService);
```

### 2. Database connection
–í—Å–µ –º–æ–¥—É–ª–∏ –ø–æ–ª—É—á–∞—é—Ç `db` –∫–∞–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä:
```js
module.exports = (db, authMiddleware) => { ... }
```

### 3. Environment variables
–í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ `process.env`

---

## üìù –î–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

### –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:

1. **routes/products.js**
   - GET /api/products
   - POST /api/products (admin)
   - PUT /api/products/:id (admin)
   - DELETE /api/products/:id (admin)

2. **routes/admin.js**
   - GET /api/admin/stats
   - GET /api/admin/orders
   - GET /api/admin/users

3. **services/notificationService.js**
   - –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Telegram
   - Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

4. **db/queries.js**
   - –í—Å–µ SQL –∑–∞–ø—Ä–æ—Å—ã –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
   - –õ–µ–≥—á–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å

---

## üéâ –ò–¢–û–ì

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –º–æ–¥—É–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:**
- ‚úÖ –ß–∏—Ç–∞–µ–º–æ—Å—Ç—å +100%
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ +100%
- ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ +100%
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å +100%

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:**
–ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π –º–æ–¥—É–ª–∏ –≤ `server.js` (–í–∞—Ä–∏–∞–Ω—Ç 1) –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π!

**–ì–û–¢–û–í–û –ö –†–ï–§–ê–ö–¢–û–†–ò–ù–ì–£!** üöÄüì¶
